import express from "express";
import fetch from "node-fetch";
import { create } from "xmlbuilder2";

const app = express();

app.get("/", (req, res) => {
  res.send("âœ… YouTube RSS Proxy is running. Use /api/rss?channel_id=...");
});

app.get("/api/rss", async (req, res) => {
  const channelId = req.query.channel_id;
  if (!channelId) {
    return res.status(400).send("âŒ Missing channel_id parameter");
  }

  try {
    const feedUrl = `https://www.youtube.com/feeds/videos.xml?channel_id=${channelId}`;
    const response = await fetch(feedUrl);
    if (!response.ok) throw new Error("Failed to fetch YouTube feed");

    const text = await response.text();
    const xml = create(text);

    // è½¬æ¢ä¸º JSON å†æå–æ•°æ®
    const json = xml.end({ format: "object" });

    const rss = create({ version: "1.0", encoding: "UTF-8" })
      .ele("rss", { version: "2.0", "xmlns:media": "http://search.yahoo.com/mrss/" })
      .ele("channel")
      .ele("title").txt(json.feed.title).up()
      .ele("link").txt(`https://www.youtube.com/channel/${channelId}`).up()
      .ele("description").txt("Generated by your Render YouTube RSS proxy").up();

    (json.feed.entry || []).forEach((video) => {
      const videoUrl = video.link["@href"];
      const videoId = video["yt:videoId"];
      const title = video.title;
      const published = video.published;
      const thumbnail = `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg`;

      rss
        .ele("item")
        .ele("title").txt(title).up()
        .ele("link").txt(videoUrl).up()
        .ele("pubDate").txt(published).up()
        .ele("media:thumbnail", { url: thumbnail }).up()
        .up();
    });

    const xmlOutput = rss.end({ prettyPrint: true });
    res.type("application/xml");
    res.send(xmlOutput);
  } catch (err) {
    console.error(err);
    res.status(500).send("âŒ Failed to fetch or parse feed");
  }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`ğŸš€ Server running on port ${PORT}`));
